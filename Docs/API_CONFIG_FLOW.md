# API配置优化 - 流程图

## 一、首次使用流程图

```
┌─────────────────┐
│  用户打开应用    │
└────────┬────────┘
         │
         ▼
┌─────────────────────────┐
│ 检查 api_config_        │
│ initialized 标志         │
└────────┬────────────────┘
         │
    ┌────┴────┐
    │         │
   否        是
    │         │
    ▼         ▼
┌─────────┐ ┌──────────────┐
│强制显示 │ │ 正常启动     │
│API配置  │ │ 进入主界面   │
│对话框   │ └──────────────┘
│(不可关闭)│
└────┬────┘
     │
     ▼
┌─────────────────────────┐
│ 显示欢迎信息和配置说明   │
│                         │
│ ┌─ Gemini API ──────┐  │
│ │ ○ 官方  ● 第三方   │  │
│ │ API Key: [____]   │  │
│ │ Base URL: [____]  │  │
│ └───────────────────┘  │
│                         │
│ ┌─ 豆包 API ────────┐  │
│ │ ○ 官方  ● 第三方   │  │
│ │ API Key: [____]   │  │
│ │ Base URL: [____]  │  │
│ └───────────────────┘  │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 用户填写配置            │
│ (至少配置一个API)       │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 点击"保存并开始使用"     │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 验证配置有效性          │
│ - 官方API: 需要API Key  │
│ - 第三方: 需要Base URL  │
│ - 至少一个API已配置     │
└────────┬────────────────┘
         │
    ┌────┴────┐
    │         │
  有效      无效
    │         │
    ▼         ▼
┌─────────┐ ┌──────────────┐
│保存配置 │ │ 显示错误提示 │
│到local  │ │ 高亮错误字段 │
│Storage  │ └──────────────┘
└────┬────┘
     │
     ▼
┌─────────────────────────┐
│ 设置 initialized = true │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 关闭对话框，进入主界面  │
└─────────────────────────┘
```

## 二、模型选择联动流程图

```
┌─────────────────┐
│  用户点击模型    │
│  选择器          │
└────────┬────────┘
         │
         ▼
┌─────────────────────────┐
│ 获取所有模型列表         │
│ - gemini-2.5-flash       │
│ - gemini-3-pro           │
│ - doubao-seedream        │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 检查每个模型对应的API    │
│ 配置状态                 │
│                         │
│ gemini-2.5 → Gemini API │
│ gemini-3 → Gemini API   │
│ doubao → 豆包 API       │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 过滤可用模型            │
│                         │
│ ✓ gemini-2.5 (已配置)   │
│ ✓ gemini-3 (已配置)     │
│ ⚠ doubao (未配置)       │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 显示模型下拉列表        │
│                         │
│ [▼] gemini-2.5-flash    │
│   ✓ Gemini API 已配置  │
│                         │
│   gemini-3-pro          │
│   ✓ Gemini API 已配置  │
│                         │
│   doubao-seedream       │
│   ⚠ 豆包 API 未配置     │
│   [点击配置]            │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 用户选择模型            │
└────────┬────────────────┘
         │
    ┌────┴────┐
    │         │
  已配置    未配置
    │         │
    ▼         ▼
┌─────────┐ ┌──────────────────┐
│允许选择 │ │ 显示提示         │
│更新状态 │ │ "请先配置豆包API"│
└─────────┘ └────────┬─────────┘
                      │
                      ▼
              ┌──────────────────┐
              │ 自动打开API配置  │
              │ 对话框          │
              └────────┬─────────┘
                       │
                       ▼
              ┌──────────────────┐
              │ 高亮显示豆包API  │
              │ 配置区域         │
              └──────────────────┘
```

## 三、API配置更新流程图

```
┌─────────────────┐
│  用户修改API     │
│  配置            │
└────────┬────────┘
         │
         ▼
┌─────────────────────────┐
│ 实时验证输入            │
│ - URL格式验证           │
│ - 必填字段检查          │
└────────┬────────────────┘
         │
    ┌────┴────┐
    │         │
  有效      无效
    │         │
    ▼         ▼
┌─────────┐ ┌──────────────┐
│更新状态 │ │ 显示错误提示 │
│指示器   │ │ 禁用保存按钮 │
└────┬────┘ └──────────────┘
     │
     ▼
┌─────────────────────────┐
│ 用户点击保存            │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 最终验证                │
│ - 至少一个API已配置     │
│ - 每个配置完整有效      │
└────────┬────────────────┘
         │
    ┌────┴────┐
    │         │
  通过      失败
    │         │
    ▼         ▼
┌─────────┐ ┌──────────────┐
│保存到   │ │ 显示错误信息 │
│local    │ │ 阻止保存     │
│Storage  │ └──────────────┘
└────┬────┘
     │
     ▼
┌─────────────────────────┐
│ 更新模型选择器          │
│ - 重新计算可用模型      │
│ - 更新模型列表          │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 检查当前选择的模型      │
│ 是否仍然可用            │
└────────┬────────────────┘
         │
    ┌────┴────┐
    │         │
   可用      不可用
    │         │
    ▼         ▼
┌─────────┐ ┌──────────────┐
│保持当前 │ │ 自动切换到   │
│选择     │ │ 第一个可用   │
│         │ │ 模型         │
└─────────┘ └──────────────┘
```

## 四、API类型切换流程图

```
┌─────────────────┐
│  用户切换API    │
│  类型           │
│  (官方/第三方)   │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
  官方      第三方
    │         │
    ▼         ▼
┌─────────┐ ┌──────────────┐
│显示字段:│ │显示字段:      │
│- API Key│ │- Base URL    │
│  (必填) │ │  (必填)      │
│         │ │- API Key     │
│         │ │  (可选)      │
└─────────┘ └──────────────┘
    │         │
    └────┬────┘
         │
         ▼
┌─────────────────────────┐
│ 清空之前的值            │
│ (如果类型不同)          │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 更新验证规则            │
│ - 官方: API Key必填     │
│ - 第三方: Base URL必填  │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 实时验证输入            │
└─────────────────────────┘
```

## 五、数据迁移流程图

```
┌─────────────────┐
│  应用启动        │
└────────┬────────┘
         │
         ▼
┌─────────────────────────┐
│ 检查新格式数据是否存在  │
└────────┬────────────────┘
         │
    ┌────┴────┐
    │         │
   存在      不存在
    │         │
    ▼         ▼
┌─────────┐ ┌──────────────────┐
│使用新   │ │ 检查旧格式数据    │
│格式数据 │ │ (gemini_api_key) │
└─────────┘ └────────┬─────────┘
                      │
                 ┌────┴────┐
                 │         │
               存在      不存在
                 │         │
                 ▼         ▼
         ┌─────────────┐ ┌──────────────┐
         │执行数据迁移  │ │ 使用默认配置 │
         │             │ │ (未初始化)    │
         └─────┬───────┘ └──────────────┘
               │
               ▼
┌─────────────────────────┐
│ 读取旧格式数据           │
│ - gemini_api_key        │
│ - gemini_base_url       │
│ - doubao_api_key        │
│ - doubao_base_url       │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 转换为新格式            │
│                         │
│ gemini_api_config: {    │
│   type: base_url ?      │
│     'third_party' :     │
│     'official',         │
│   api_key: xxx,         │
│   base_url: xxx,        │
│   configured: true      │
│ }                       │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 保存新格式数据           │
│ 到 localStorage         │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 设置 initialized = true  │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│ 可选：删除旧格式数据     │
│ (或保留作为备份)         │
└─────────────────────────┘
```

